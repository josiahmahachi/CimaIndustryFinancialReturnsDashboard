@* Filters Section - Search, Fund Type, Status, Period Year - matches React implementation *@
@using blazor_wasm_ui.Models

<div class="bg-white rounded-lg border border-neutral-200 shadow-sm mb-6">
    <div class="p-6">
        <div class="flex items-end justify-between gap-4">
            <div class="@GetGridColsClass() flex-1 grid gap-4">
                <!-- Search Input -->
                <div>
                    <label class="block text-sm text-neutral-700 mb-2">Search</label>
                    <div class="relative">
                        <input
                            type="text"
                            class="w-full px-3 py-2 pl-10 border border-neutral-300 rounded text-sm bg-white focus:outline-none focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900"
                            placeholder="Search by entity name, entity ID, or filing ID..."
                            value="@SearchQuery"
                            @onchange="@((ChangeEventArgs e) => OnSearchChange.InvokeAsync(e.Value?.ToString() ?? ""))" />
                        @RenderSearchIcon()
                    </div>
                </div>

                <!-- Entity Type Dropdown -->
                <div>
                    <label class="block text-sm text-neutral-700 mb-2">Entity Type</label>
                    <select
                        class="w-full px-3 py-2 border border-neutral-300 rounded text-sm bg-white cursor-pointer focus:outline-none focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900"
                        value="@FundType"
                        @onchange="@((ChangeEventArgs e) => OnFundTypeChange.InvokeAsync(e.Value?.ToString() ?? "all"))">
                        <option value="all">All Entity Types</option>
                        <option value="mutual">Mutual Fund</option>
                        <option value="private">Private Fund</option>
                    </select>
                </div>

                <!-- Status Multi-Select (conditional) -->
                @if (!HideStatusFilter)
                {
                    <div>
                        <label class="block text-sm text-neutral-700 mb-2">Status</label>
                        <button 
                            class="w-full px-3 py-2 border border-neutral-300 rounded text-sm bg-white cursor-pointer text-left focus:outline-none focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 flex items-center justify-between text-neutral-900"
                            @onclick="@(() => StatusOpen = !StatusOpen)">
                            <span class="truncate">@GetStatusLabel()</span>
                            @RenderChevronDownIcon()
                        </button>
                        @if (StatusOpen)
                        {
                            <div class="absolute top-full left-0 z-10 bg-white border border-neutral-300 rounded mt-1 shadow-md w-60 overflow-hidden">
                                <div class="p-2">
                                    @foreach (var option in GetFilteredStatusOptions())
                                    {
                                        <div class="flex items-center justify-between px-3 py-2 hover:bg-neutral-100 rounded cursor-pointer text-sm text-neutral-700" @onclick="@(async () => await HandleStatusToggle(option.Value))">
                                            <span>@option.Label</span>
                                            @if (Status.Contains(option.Value))
                                            {
                                                @RenderCheckIcon()
                                            }
                                        </div>
                                    }
                                </div>
                                @if (Status.Count > 0)
                                {
                                    <div class="border-t border-neutral-200 p-2">
                                        <button
                                            class="w-full px-3 py-1 text-xs text-neutral-700 hover:bg-neutral-100 rounded transition-colors"
                                            @onclick="@(async () => await OnStatusChange.InvokeAsync(new List<string>()))">
                                            Clear selection
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                <!-- Period Year Multi-Select -->
                <div>
                    <label class="block text-sm text-neutral-700 mb-2">Period Year</label>
                    <button 
                        class="w-full px-3 py-2 border border-neutral-300 rounded text-sm bg-white cursor-pointer text-left focus:outline-none focus:border-neutral-900 focus:ring-1 focus:ring-neutral-900 flex items-center justify-between text-neutral-900"
                        @onclick="@(() => YearOpen = !YearOpen)">
                        <span class="truncate">@GetYearLabel()</span>
                        @RenderChevronDownIcon()
                    </button>
                    @if (YearOpen)
                    {
                        <div class="absolute top-full left-0 z-10 bg-white border border-neutral-300 rounded mt-1 shadow-md w-60 overflow-hidden">
                            <div class="p-2">
                                @foreach (var year in GetYearOptions())
                                {
                                    <div class="flex items-center justify-between px-3 py-2 hover:bg-neutral-100 rounded cursor-pointer text-sm text-neutral-700" @onclick="@(async () => await HandleYearToggle(year))">
                                        <span>@year</span>
                                        @if (PeriodYear.Contains(year))
                                        {
                                            @RenderCheckIcon()
                                        }
                                    </div>
                                }
                            </div>
                            @if (PeriodYear.Count > 0)
                            {
                                <div class="border-t border-neutral-200 p-2">
                                    <button
                                        class="w-full px-3 py-1 text-xs text-neutral-700 hover:bg-neutral-100 rounded transition-colors"
                                        @onclick="@(async () => await OnPeriodYearChange.InvokeAsync(new List<string>()))">
                                        Clear selection
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Clear Filters Button -->
            <button 
                class="px-4 py-2 border border-neutral-300 rounded text-sm text-neutral-600 hover:text-neutral-900 bg-white cursor-pointer transition-colors flex items-center gap-2"
                @onclick="@(() => OnResetFilters.InvokeAsync(null))">
                <span class="text-neutral-400">âœ•</span>
                Clear Filters
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string FundType { get; set; } = "all";

    [Parameter]
    public List<string> Status { get; set; } = new();

    [Parameter]
    public List<string> PeriodYear { get; set; } = new();

    [Parameter]
    public List<string> AvailableYears { get; set; } = new();

    [Parameter]
    public string SearchQuery { get; set; } = "";

    [Parameter]
    public EventCallback<string> OnFundTypeChange { get; set; }

    [Parameter]
    public EventCallback<List<string>> OnStatusChange { get; set; }

    [Parameter]
    public EventCallback<List<string>> OnPeriodYearChange { get; set; }

    [Parameter]
    public EventCallback<string> OnSearchChange { get; set; }

    [Parameter]
    public EventCallback OnResetFilters { get; set; }

    [Parameter]
    public bool HideStatusFilter { get; set; } = false;

    [Parameter]
    public bool ShowStatusFilter { get; set; } = false;

    [Parameter]
    public string ActiveTab { get; set; } = "active";

    private bool StatusOpen { get; set; } = false;
    private bool YearOpen { get; set; } = false;

    private List<(string Value, string Label)> StatusOptions { get; set; } = new()
    {
        ("available", "Available"),
        ("prepared", "Prepared"),
        ("ready to submit", "Ready to Submit"),
        ("processed", "Processed"),
        ("returned", "Returned"),
        ("waived", "Waived"),
        ("outstanding", "Outstanding"),
        ("deferred", "Deferred"),
    };

    private List<string> YearOptions { get; set; } = new() { "2025", "2024", "2023" };

    /// <summary>
    /// Render search icon as SVG
    /// </summary>
    private MarkupString RenderSearchIcon()
    {
        var svg = """<svg class="w-4 h-4 absolute left-3 top-3 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>""";
        return new MarkupString(svg);
    }

    /// <summary>
    /// Render check icon as SVG
    /// </summary>
    private MarkupString RenderCheckIcon()
    {
        var svg = """<svg class="h-4 w-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>""";
        return new MarkupString(svg);
    }

    /// <summary>
    /// Render chevron down icon as SVG
    /// </summary>
    private MarkupString RenderChevronDownIcon()
    {
        var svg = """<svg class="ml-2 h-4 w-4 shrink-0 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>""";
        return new MarkupString(svg);
    }

    /// <summary>
    /// Get grid column class based on status filter visibility
    /// </summary>
    private string GetGridColsClass()
    {
        return HideStatusFilter ? "md:grid-cols-3" : "md:grid-cols-4";
    }

    /// <summary>
    /// Get filtered status options based on active tab
    /// </summary>
    private List<(string Value, string Label)> GetFilteredStatusOptions()
    {
        return ActiveTab switch
        {
            "active" => StatusOptions.Where(opt => 
                new[] { "available", "prepared", "ready to submit", "waived", "outstanding", "deferred" }.Contains(opt.Value)).ToList(),
            "submitted" => StatusOptions.Where(opt => opt.Value == "processed").ToList(),
            "returned" => StatusOptions.Where(opt => opt.Value == "returned").ToList(),
            _ => StatusOptions
        };
    }

    /// <summary>
    /// Get year options (hardcoded to match React)
    /// </summary>
    private List<string> GetYearOptions()
    {
        return YearOptions;
    }

    /// <summary>
    /// Get status label for button display
    /// </summary>
    private string GetStatusLabel()
    {
        if (Status.Count == 0) return "All Statuses";
        if (Status.Count == 1)
        {
            var option = StatusOptions.FirstOrDefault(opt => opt.Value == Status[0]);
            return option.Label ?? "All Statuses";
        }
        return $"{Status.Count} selected";
    }

    /// <summary>
    /// Get year label for button display
    /// </summary>
    private string GetYearLabel()
    {
        if (PeriodYear.Count == 0) return "All Years";
        if (PeriodYear.Count == 1) return PeriodYear[0];
        return $"{PeriodYear.Count} selected";
    }

    /// <summary>
    /// Handle status filter toggle
    /// </summary>
    private async Task HandleStatusToggle(string value)
    {
        var newStatus = new List<string>(Status);
        if (newStatus.Contains(value))
        {
            newStatus.Remove(value);
        }
        else
        {
            newStatus.Add(value);
        }
        await OnStatusChange.InvokeAsync(newStatus);
    }

    /// <summary>
    /// Handle year filter toggle
    /// </summary>
    private async Task HandleYearToggle(string value)
    {
        var newYears = new List<string>(PeriodYear);
        if (newYears.Contains(value))
        {
            newYears.Remove(value);
        }
        else
        {
            newYears.Add(value);
        }
        await OnPeriodYearChange.InvokeAsync(newYears);
    }
}
